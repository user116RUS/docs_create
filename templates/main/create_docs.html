{% extends '../wrapper.html' %}

{% block title %}Новый документ{% endblock %}

{% block content %}
{% load user_filters %}
<style>
    .input-sm {
        height: 38px !important;
    }
    .select-sm {
        height: 38px !important;
    }
    .service-card {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-bottom: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    .service-card.selected {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .service-header {
        background-color: #f8f9fa;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .service-card.selected .service-header {
        background-color: #e9f0fd;
    }
    .service-body {
        padding: 15px;
    }
    .category-item {
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
    }
    .category-item:last-child {
        border-bottom: none;
    }
    .selected-services-summary {
        background-color: #f0f9ff;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
        border: 1px solid #cfe2ff;
    }
    .service-checkbox {
        width: 20px;
        height: 20px;
    }
    .modal-backdrop {
        opacity: 0.5 !important;
    }
    .category-form-row {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        position: relative;
    }
    .remove-category {
        position: absolute;
        right: 10px;
        top: 10px;
        cursor: pointer;
        color: #dc3545;
    }
</style>
<div class="row my-4">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-file-earmark-plus me-2"></i>Создание нового документа</h4>
            </div>
            <div class="card-body p-4">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle-fill me-2"></i>Заполните информацию для создания документов. После заполнения вы сможете скачать акт приемки, счет и договор.
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.doer.id_for_label }}" class="form-label">{{ form.doer.label }}</label>
                                {{ form.doer|addclass:"form-control select-sm" }}
                                <div class="form-text">{{ form.doer.help_text }}</div>
                                {% if form.doer.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.doer.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="{{ form.customer.id_for_label }}" class="form-label">{{ form.customer.label }}</label>
                                {{ form.customer|addclass:"form-control select-sm" }}
                                <div class="form-text">{{ form.customer.help_text }}</div>
                                {% if form.customer.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.customer.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.date.id_for_label }}" class="form-label">{{ form.date.label }}</label>
                                {{ form.date|addclass:"form-control input-sm" }}
                                <div class="form-text">{{ form.date.help_text }}</div>
                                {% if form.date.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.date.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="{{ form.time.id_for_label }}" class="form-label">{{ form.time.label }}</label>
                                {{ form.time|addclass:"form-control input-sm" }}
                                <div class="form-text">{{ form.time.help_text }}</div>
                                {% if form.time.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.time.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.address_and_time.id_for_label }}" class="form-label">{{ form.address_and_time.label }}</label>
                                {{ form.address_and_time|addclass:"form-control input-sm" }}
                                <div class="form-text">{{ form.address_and_time.help_text }}</div>
                                {% if form.address_and_time.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.address_and_time.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Добавляем поле для количества зрителей -->
                            <div class="form-group mb-3">
                                <label for="{{ form.viewers.id_for_label }}" class="form-label">
                                    {{ form.viewers.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.viewers|addclass:"form-control input-sm" }}
                                <div class="form-text">{{ form.viewers.help_text }}</div>
                                {% if form.viewers.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.viewers.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ form.act_and_account_number.id_for_label }}" class="form-label">{{ form.act_and_account_number.label }}</label>
                                {{ form.act_and_account_number|addclass:"form-control input-sm" }}
                                <div class="form-text">{{ form.act_and_account_number.help_text }}</div>
                                {% if form.act_and_account_number.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.act_and_account_number.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="{{ form.number_basis_of_the_contract.id_for_label }}" class="form-label">{{ form.number_basis_of_the_contract.label }}</label>
                                {{ form.number_basis_of_the_contract|addclass:"form-control input-sm" }}
                                <div class="form-text">{{ form.number_basis_of_the_contract.help_text }}</div>
                                {% if form.number_basis_of_the_contract.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.number_basis_of_the_contract.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Скрытые поля для автоматически рассчитываемых значений -->
                    {{ form.price_in_figures.as_hidden }}
                    
                    <!-- Раздел услуг -->
                    <div class="card mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Услуги</h5>
                            <a href="#" id="createServiceBtn" class="btn btn-sm btn-success">
                                <i class="bi bi-plus-circle me-1"></i>Добавить новую услугу
                            </a>
                        </div>
                        <div class="card-body">
                            <!-- Скрытое поле для правильной обработки формы -->
                            {{ form.services.as_hidden }}
                            
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle-fill me-2"></i>Выберите услуги, которые требуется включить в документы. Вы можете выбрать несколько услуг.
                            </div>
                            
                            <!-- Отображение ошибок формы -->
                            {% if form.non_field_errors %}
                            <div class="alert alert-danger mb-3">
                                {% for error in form.non_field_errors %}
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <div class="mt-3">
                                {% if services %}
                                    {% for service in services %}
                                    <!-- Добавляем отладочную информацию -->
                                    <!-- Debug: {{ service.name }} - viewers: {{ service.total_viewers }}, price: {{ service.total_price }} -->
                                    <div class="service-card" data-service-id="{{ service.id }}" 
                                         data-viewers="{{ service.total_viewers|default:'0' }}" 
                                         data-price="{{ service.total_price|default:'0' }}">
                                        <div class="service-header">
                                            <div class="d-flex align-items-center">
                                                <div class="form-check form-check-inline me-3">
                                                    <input class="form-check-input service-checkbox" type="checkbox" name="service_checkbox" 
                                                        id="service_{{ service.id }}" value="{{ service.id }}"
                                                        {% if service in form.instance.services.all %}checked{% endif %}>
                                                    <label class="form-check-label" for="service_{{ service.id }}">
                                                        {{ service.name }} ({{ service.date }})
                                                    </label>
                                                </div>
                                            </div>
                                            <div>
                                                <a href="#" class="btn btn-sm btn-outline-primary edit-service-btn">
                                                    <i class="bi bi-pencil-square"></i>
                                                </a>
                                            </div>
                                        </div>
                                        <div class="service-body">
                                            {% with categories=service.viewer_categories.all %}
                                                {% if categories %}
                                                    <div class="mb-2"><strong>Категории зрителей:</strong></div>
                                                    {% for category in categories %}
                                                    <div class="category-item">
                                                        <div class="d-flex justify-content-between">
                                                            <div>{{ category.viewers }} чел.</div>
                                                            <div>{{ category.price }} руб.</div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                    <div class="mt-2 text-end">
                                                        <span class="badge bg-info text-white">Всего: {{ service.total_viewers }} чел.</span>
                                                        <span class="badge bg-success text-white">Итого: {{ service.total_price }} руб.</span>
                                                    </div>
                                                {% else %}
                                                    <div class="text-muted">Нет добавленных категорий зрителей</div>
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Нет доступных услуг. Добавьте услугу с помощью кнопки выше.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Перемещаем блок сводки сюда -->
                    <div class="selected-services-summary d-none" id="selectedServicesSummary">
                        <h6 class="mb-3"><i class="bi bi-check-circle-fill me-2"></i>Сводная информация:</h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="card bg-light h-100">
                                    <div class="card-body py-2 px-3">
                                        <h6 class="mb-2">Выбранные услуги</h6>
                                        <div class="h4"><span id="selectedServicesCount" class="fw-bold">0</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light h-100">
                                    <div class="card-body py-2 px-3">
                                        <h6 class="mb-2">Количество зрителей</h6>
                                        <div class="h4"><span id="selectedServicesTotal" class="fw-bold">0</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-primary text-white h-100">
                                    <div class="card-body py-2 px-3">
                                        <h6 class="mb-2">Общая стоимость</h6>
                                        <div class="h4"><span id="selectedServicesPrice" class="fw-bold">0 руб.</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-info-circle-fill me-2"></i>Цена будет автоматически вставлена в документы в числовом и текстовом формате.
                        </div>
                        
                        <!-- Добавляем поле для суммы прописью -->
                        <div class="form-group mt-3">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Внимание!</strong> Укажите сумму прописью для документов:
                            </div>
                            <label for="{{ form.price_in_words.id_for_label }}" class="form-label">
                                {{ form.price_in_words.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.price_in_words|addclass:"form-control" }}
                            <div class="form-text">{{ form.price_in_words.help_text }}</div>
                            {% if form.price_in_words.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.price_in_words.errors }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'main:index' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Вернуться
                        </a>
                        <button type="submit" id="submitButton" class="btn btn-primary">
                            <i class="bi bi-file-earmark-check me-1"></i>Создать документы
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для создания/редактирования услуги -->
<div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceModalLabel">Создание новой услуги</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="serviceForm">
                    <input type="hidden" id="serviceId" value="">
                    
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="form-group mb-3">
                                <label for="serviceName" class="form-label">Название услуги</label>
                                <input type="text" class="form-control" id="serviceName" required>
                                <div class="invalid-feedback" id="serviceNameError"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="serviceDate" class="form-label">Срок оказания услуг</label>
                                <input type="text" class="form-control" id="serviceDate" required>
                                <div class="invalid-feedback" id="serviceDateError"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mb-3">Категории зрителей</h5>
                    <div id="categoriesContainer"></div>
                    
                    <button type="button" id="addCategoryBtn" class="btn btn-outline-success mb-4">
                        <i class="bi bi-plus-circle me-1"></i>Добавить категорию
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveServiceBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteServiceModal" tabindex="-1" aria-labelledby="deleteServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteServiceModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы действительно хотите удалить услугу "<span id="deleteServiceName"></span>"?</p>
                <p class="text-danger">Это действие нельзя отменить.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Получаем форму и кнопку отправки
    const form = document.querySelector('form');
    const submitButton = document.getElementById('submitButton');
    
    // Обработчик отправки формы для предотвращения двойной отправки
    if (form && submitButton) {
        form.addEventListener('submit', function(e) {
            // Проверяем, есть ли выбранные услуги
            const selectedServices = document.querySelectorAll('.hidden-service-input');
            if (selectedServices.length === 0) {
                e.preventDefault();
                alert('Пожалуйста, выберите хотя бы одну услугу.');
                return false;
            }
            
            // Блокируем кнопку отправки
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Создание...';
        });
    }
    
    // Получаем скрытое поле и все чекбоксы услуг
    const servicesField = document.getElementById('id_services');
    const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
    const serviceCards = document.querySelectorAll('.service-card');
    const selectedServicesSummary = document.getElementById('selectedServicesSummary');
    
    // Получаем элементы для обновления информации, проверяя их существование
    let selectedServicesCount = null;
    let selectedServicesTotal = null;
    let selectedServicesPrice = null;
    
    if (selectedServicesSummary) {
        selectedServicesCount = document.getElementById('selectedServicesCount');
        selectedServicesTotal = document.getElementById('selectedServicesTotal');
        selectedServicesPrice = document.getElementById('selectedServicesPrice');
        
        console.log('Found elements:', {
            count: selectedServicesCount,
            total: selectedServicesTotal,
            price: selectedServicesPrice
        });
    }
    
    const priceInFigures = document.getElementById('id_price_in_figures');
    const priceInWords = document.getElementById('id_price_in_words');
    const viewersField = document.getElementById('id_viewers');
    
    // Обновляем сводку по выбранным услугам
    function updateServicesSummary() {
        let count = 0;
        let totalViewers = 0;
        let totalPrice = 0;
        
        serviceCheckboxes.forEach(function(checkbox) {
            if (checkbox.checked) {
                count++;
                const card = checkbox.closest('.service-card');
                if (card) {
                    // Добавляем отладочную информацию
                    console.log('Card data:', {
                        id: card.dataset.serviceId,
                        viewers: card.dataset.viewers,
                        price: card.dataset.price
                    });
                    
                    // Преобразуем строковые значения в числа
                    const viewers = parseInt(card.dataset.viewers) || 0;
                    const price = parseFloat(card.dataset.price) || 0;
                    
                    console.log(`Service ${card.dataset.serviceId}: viewers=${viewers}, price=${price}`);
                    
                    totalViewers += viewers;
                    totalPrice += price;
                }
            }
        });
        
        console.log(`Total: count=${count}, viewers=${totalViewers}, price=${totalPrice}`);
        
        // Обновляем информацию в сводке
        if (selectedServicesCount) {
            selectedServicesCount.textContent = count;
            console.log('Updated count:', count);
        }
        if (selectedServicesTotal) {
            selectedServicesTotal.textContent = totalViewers;
            console.log('Updated viewers:', totalViewers);
        }
        if (selectedServicesPrice) {
            selectedServicesPrice.textContent = totalPrice.toFixed(2) + ' руб.';
            console.log('Updated price:', totalPrice);
        }
        
        // Автоматически заполняем поля с ценой в форме
        if (priceInFigures && totalPrice > 0) {
            priceInFigures.value = totalPrice.toFixed(2);
        }
        
        // Показываем или скрываем блок сводки
        if (selectedServicesSummary) {
            if (count > 0) {
                selectedServicesSummary.classList.remove('d-none');
                console.log('Showing summary block');
            } else {
                selectedServicesSummary.classList.add('d-none');
                console.log('Hiding summary block');
            }
        }
    }
    
    // Обновляем скрытое поле формы при изменении чекбокса
    function updateServicesField() {
        const selectedServices = [];
        
        // Собираем все выбранные ID услуг
        serviceCheckboxes.forEach(function(checkbox) {
            if (checkbox.checked) {
                selectedServices.push(checkbox.value);
            }
        });
        
        // Создаем скрытые поля для каждой выбранной услуги
        // Сначала удаляем существующие скрытые поля
        document.querySelectorAll('.hidden-service-input').forEach(function(input) {
            input.remove();
        });
        
        // Создаем новые скрытые поля для каждого выбранного сервиса
        if (form) {
            selectedServices.forEach(function(serviceId) {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'services';
                hiddenInput.value = serviceId;
                hiddenInput.className = 'hidden-service-input';
                form.appendChild(hiddenInput);
            });
        }
    }
    
    // Устанавливаем обработчики на чекбоксы
    serviceCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            console.log('Checkbox changed:', this.checked);
            updateServicesField();
            updateServiceCardSelection(this);
            updateServicesSummary();
        });
    });
    
    // Добавляем обработчик клика на карточку услуги
    serviceCards.forEach(function(card) {
        card.addEventListener('click', function(e) {
            // Проверяем, что клик не был на кнопке редактирования или чекбоксе
            if (!e.target.closest('a') && !e.target.closest('.form-check-input')) {
                const checkbox = this.querySelector('.service-checkbox');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    
                    // Имитируем событие change на чекбоксе
                    const event = new Event('change');
                    checkbox.dispatchEvent(event);
                }
            }
        });
    });
    
    // Обновляем классы карточек при выборе/отмене
    function updateServiceCardSelection(checkbox) {
        const card = checkbox.closest('.service-card');
        if (card) {
            if (checkbox.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }
    }
    
    // Инициализируем поле и стили при загрузке страницы
    updateServicesField();
    
    // Инициализируем стили выбранных карточек
    serviceCheckboxes.forEach(function(checkbox) {
        if (checkbox.checked) {
            const card = checkbox.closest('.service-card');
            if (card) {
                card.classList.add('selected');
                // Добавляем отладочную информацию при инициализации
                console.log('Initial card data:', {
                    id: card.dataset.serviceId,
                    viewers: card.dataset.viewers,
                    price: card.dataset.price
                });
            }
        }
    });
    
    // Инициализируем сводку
    updateServicesSummary();
    
    // Функции для модального окна услуг
    const serviceModalElement = document.getElementById('serviceModal');
    const deleteServiceModalElement = document.getElementById('deleteServiceModal');
    
    // Проверяем, что элементы существуют и bootstrap доступен
    let serviceModal, deleteServiceModal;
    if (typeof bootstrap !== 'undefined') {
        if (serviceModalElement) {
            serviceModal = new bootstrap.Modal(serviceModalElement);
        }
        if (deleteServiceModalElement) {
            deleteServiceModal = new bootstrap.Modal(deleteServiceModalElement);
        }
    } else {
        console.error('Bootstrap не найден! Убедитесь, что библиотека правильно подключена.');
    }
    
    const serviceForm = document.getElementById('serviceForm');
    const serviceIdField = document.getElementById('serviceId');
    const serviceNameField = document.getElementById('serviceName');
    const serviceDateField = document.getElementById('serviceDate');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const saveServiceBtn = document.getElementById('saveServiceBtn');
    const deleteServiceName = document.getElementById('deleteServiceName');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    // Добавляем обработчик на кнопку "Добавить новую услугу"
    const createServiceBtn = document.getElementById('createServiceBtn');
    if (createServiceBtn) {
        createServiceBtn.addEventListener('click', function(e) {
            e.preventDefault();
            openServiceModal();
        });
    }
    
    // Модифицируем кнопки редактирования услуг
    const editButtons = document.querySelectorAll('.service-header .edit-service-btn');
    editButtons.forEach(function(button) {
        // Удаляем атрибут href
        button.removeAttribute('href');
        // Добавляем класс edit-service-btn для идентификации
        button.classList.add('edit-service-btn');
    });
    
    // Обработчик на кнопки редактирования услуг
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-service-btn')) {
            e.preventDefault();
            const serviceCard = e.target.closest('.service-card');
            const serviceId = serviceCard.dataset.serviceId;
            openServiceModal(serviceId);
        }
    });
    
    // Добавляем кнопки удаления услуг
    const serviceHeaders = document.querySelectorAll('.service-header');
    serviceHeaders.forEach(function(header) {
        const buttonsContainer = header.querySelector('div:last-child');
        if (buttonsContainer) {
            // Проверяем, нет ли уже кнопки удаления
            if (!buttonsContainer.querySelector('.delete-service-btn')) {
                const deleteButton = document.createElement('button');
                deleteButton.className = 'btn btn-sm btn-outline-danger ms-2 delete-service-btn';
                deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
                buttonsContainer.appendChild(deleteButton);
            }
        }
    });
    
    // Обработчик на кнопки удаления услуг
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-service-btn')) {
            e.preventDefault();
            const serviceCard = e.target.closest('.service-card');
            const serviceId = serviceCard.dataset.serviceId;
            const serviceName = serviceCard.querySelector('.form-check-label').textContent.trim();
            openDeleteModal(serviceId, serviceName);
        }
    });
    
    // Функция открытия модального окна услуги
    function openServiceModal(serviceId = null) {
        // Проверяем, инициализировано ли модальное окно
        if (!serviceModal) {
            alert('Не удалось открыть модальное окно. Проблема с Bootstrap.');
            return;
        }
        
        // Очищаем форму
        serviceForm.reset();
        serviceIdField.value = '';
        categoriesContainer.innerHTML = '';
        
        if (serviceId) {
            // Редактирование существующей услуги
            const serviceCard = document.querySelector(`.service-card[data-service-id="${serviceId}"]`);
            if (serviceCard) {
                // Заполняем поля формы
                serviceIdField.value = serviceId;
                const nameLabel = serviceCard.querySelector('.form-check-label').textContent.trim();
                const nameParts = nameLabel.split('(');
                serviceNameField.value = nameParts[0].trim();
                serviceDateField.value = nameParts[1].replace(')', '').trim();
                
                // Добавляем категории
                const categoryItems = serviceCard.querySelectorAll('.category-item');
                categoryItems.forEach(function(item) {
                    const viewersText = item.querySelector('div:first-child').textContent.trim();
                    const priceText = item.querySelector('div:last-child').textContent.trim();
                    
                    const viewers = parseInt(viewersText.replace(' чел.', ''));
                    const price = parseFloat(priceText.replace(' руб.', ''));
                    
                    addCategoryRow(viewers, price);
                });
                
                // Меняем заголовок
                document.getElementById('serviceModalLabel').textContent = 'Редактирование услуги';
            }
        } else {
            // Создание новой услуги
            document.getElementById('serviceModalLabel').textContent = 'Создание новой услуги';
            // Добавляем пустую категорию
            addCategoryRow();
        }
        
        // Открываем модальное окно
        serviceModal.show();
    }
    
    // Функция добавления строки категории
    function addCategoryRow(viewers = '', price = '') {
        const index = document.querySelectorAll('.category-form-row').length;
        
        const row = document.createElement('div');
        row.className = 'category-form-row';
        row.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">Кол-во зрителей</label>
                        <input type="number" class="form-control category-viewers" min="1" value="${viewers}" required>
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">Цена за единицу</label>
                        <input type="number" class="form-control category-price" min="0.01" step="0.01" value="${price}" required>
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
            </div>
            <span class="remove-category"><i class="bi bi-x-circle"></i></span>
        `;
        
        categoriesContainer.appendChild(row);
        
        // Добавляем обработчик на кнопку удаления категории
        row.querySelector('.remove-category').addEventListener('click', function() {
            // Не позволяем удалить последнюю категорию
            if (document.querySelectorAll('.category-form-row').length > 1) {
                row.remove();
            } else {
                alert('Должна быть как минимум одна категория зрителей');
            }
        });
    }
    
    // Обработчик на кнопку добавления категории
    addCategoryBtn.addEventListener('click', function() {
        addCategoryRow();
    });
    
    // Обработчик на кнопку сохранения услуги
    saveServiceBtn.addEventListener('click', function() {
        // Проверяем валидность формы
        if (!serviceForm.checkValidity()) {
            serviceForm.classList.add('was-validated');
            return;
        }
        
        // Собираем данные формы
        const serviceId = serviceIdField.value;
        const serviceName = serviceNameField.value;
        const serviceDate = serviceDateField.value;
        
        const categories = [];
        const categoryRows = document.querySelectorAll('.category-form-row');
        categoryRows.forEach(function(row) {
            const viewers = parseInt(row.querySelector('.category-viewers').value);
            const price = parseFloat(row.querySelector('.category-price').value);
            
            if (viewers && price) {
                categories.push({
                    viewers,
                    price
                });
            }
        });
        
        // Проверяем, что есть хотя бы одна категория
        if (categories.length === 0) {
            alert('Добавьте хотя бы одну категорию зрителей');
            return;
        }
        
        // Отправляем данные на сервер
        const action = serviceId ? 'edit' : 'create';
        const data = {
            action,
            service_id: serviceId,
            service: {
                name: serviceName,
                date: serviceDate
            },
            categories
        };
        
        // Отправляем AJAX-запрос
        fetch('{% url "main:service_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно (проверяем инициализацию)
                if (serviceModal) {
                    serviceModal.hide();
                }
                
                // Обновляем страницу для отображения изменений
                window.location.reload();
            } else {
                // Отображаем ошибки
                if (data.errors) {
                    if (data.errors.name) {
                        serviceNameField.classList.add('is-invalid');
                        document.getElementById('serviceNameError').textContent = data.errors.name.join(', ');
                    }
                    if (data.errors.date) {
                        serviceDateField.classList.add('is-invalid');
                        document.getElementById('serviceDateError').textContent = data.errors.date.join(', ');
                    }
                } else {
                    alert('Произошла ошибка при сохранении услуги');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при сохранении услуги');
        });
    });
    
    // Функция открытия модального окна подтверждения удаления
    function openDeleteModal(serviceId, serviceName) {
        // Проверяем, инициализировано ли модальное окно
        if (!deleteServiceModal) {
            alert('Не удалось открыть модальное окно. Проблема с Bootstrap.');
            return;
        }
        
        document.getElementById('deleteServiceName').textContent = serviceName;
        confirmDeleteBtn.dataset.serviceId = serviceId;
        deleteServiceModal.show();
    }
    
    // Обработчик на кнопку подтверждения удаления
    confirmDeleteBtn.addEventListener('click', function() {
        const serviceId = this.dataset.serviceId;
        
        // Отправляем AJAX-запрос
        fetch('{% url "main:service_ajax" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify({
                action: 'delete',
                service_id: serviceId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно (проверяем инициализацию)
                if (deleteServiceModal) {
                    deleteServiceModal.hide();
                }
                
                // Удаляем карточку услуги из DOM
                const serviceCard = document.querySelector(`.service-card[data-service-id="${serviceId}"]`);
                if (serviceCard) {
                    serviceCard.remove();
                }
                
                // Обновляем выбранные услуги
                updateServicesField();
                updateServicesSummary();
            } else {
                alert('Произошла ошибка при удалении услуги');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при удалении услуги');
        });
    });
});
</script>
{% endblock %}